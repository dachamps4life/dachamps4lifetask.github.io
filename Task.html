<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Archive Task App</title>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --text: #f0f0f0; --accent: #bb86fc; --delete: #ff5252; --success: #00e676; --drag-hint: #3700b3; }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        
        .header { text-align: center; margin-bottom: 30px; }
        .header svg { display: block; margin: 0 auto 10px; }
        .header h1 { margin: 0; color: var(--accent); font-size: 1.5rem; }
        
        .layout { display: flex; gap: 24px; max-width: 1000px; width: 100%; flex-wrap: wrap; }
        .card { background: var(--card); padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); flex: 1; min-width: 350px; border: 1px solid #333; }
        
        .sync-btn { background: #4285F4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }

        /* CALENDAR */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .day { padding: 12px 5px; border-radius: 8px; cursor: pointer; background: #252525; font-size: 0.9rem; position: relative; min-height: 50px; transition: all 0.2s ease; border: 1px solid transparent; }
        .day:hover { background: #333; border-color: #555; }
        .day.drag-over { background: var(--drag-hint) !important; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .day.selected { border: 2px solid var(--accent); background: #2d2d2d; }
        .day.today { color: var(--accent); font-weight: 800; text-decoration: underline; }
        
        .day-progress-mini { position: absolute; bottom: 6px; left: 10%; width: 80%; height: 4px; background: #111; border-radius: 2px; overflow: hidden; }
        .day-progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.4s ease; }

        /* TASK UI */
        .input-group { display: flex; gap: 10px; margin: 20px 0; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #0f0f0f; color: white; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 8px rgba(187,134,252,0.3); }
        button#add-btn { background: var(--accent); color: #000; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        ul { list-style: none; padding: 0; }
        li { background: #252525; margin-bottom: 10px; padding: 14px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; cursor: grab; border: 1px solid #333; }
        li:active { cursor: grabbing; scale: 0.98; }

        .task-text { flex-grow: 1; font-weight: 400; }
        .completed { text-decoration: line-through; opacity: 0.4; color: #888; }
        .delete-btn { color: var(--delete); background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0 10px; }

        .progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 8px; color: #aaa; }
        .progress-container { background: #111; border-radius: 20px; height: 10px; overflow: hidden; margin-top: 10px; border: 1px solid #333; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #bb86fc, #00e676); width: 0%; transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body>

<div class="header">
    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="4" width="18" height="18" rx="2" stroke="#bb86fc" stroke-width="2"/>
        <path d="M3 10H21" stroke="#bb86fc" stroke-width="2"/>
        <path d="M8 2V6" stroke="#bb86fc" stroke-width="2" stroke-linecap="round"/>
        <path d="M16 2V6" stroke="#bb86fc" stroke-width="2" stroke-linecap="round"/>
        <path d="M9 16L11 18L15 14" stroke="#00e676" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <h1>TaskMaster</h1>
    <button id="auth_button" class="sync-btn" onclick="handleAuthClick()">Sync with Google Calendar</button>
</div>

<div class="layout">
    <div class="card">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)" style="background:none; border:none; color:white; cursor:pointer; font-size:1.2rem;">‚ùÆ</button>
            <h3 id="monthDisplay">Month Year</h3>
            <button onclick="changeMonth(1)" style="background:none; border:none; color:white; cursor:pointer; font-size:1.2rem;">‚ùØ</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="card">
        <h3 id="selectedDateTitle" style="margin-top:0;">Select a Date</h3>
        <div class="input-group">
            <input type="text" id="taskInput" placeholder="What's the plan?" autocomplete="off">
            <button id="add-btn" onclick="addTask()">Add</button>
        </div>
        <ul id="taskList"></ul>
        
        <div class="progress-section" style="margin-top:30px;">
            <div class="progress-label">
                <span>Daily Completion</span>
                <span id="percentLabel">0%</span>
            </div>
            <div class="progress-container"><div id="mainProgressBar" class="progress-bar"></div></div>
        </div>
    </div>
</div>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

<script>
    // CORE APP STATE
    let currentViewDate = new Date();
    let selectedDateStr = new Date().toLocaleDateString('en-CA');
    let allTasks = JSON.parse(localStorage.getItem('persistentCalendarTasks')) || {};

    // GOOGLE AUTH CONFIG
    const CLIENT_ID = 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // EVENT LISTENERS
    document.getElementById('taskInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') addTask(); });

    // CALENDAR FUNCTIONS
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthDisplay = document.getElementById('monthDisplay');
        grid.innerHTML = '';

        const year = currentViewDate.getFullYear();
        const month = currentViewDate.getMonth();
        monthDisplay.innerText = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentViewDate);

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));

        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const dateStr = dateObj.toLocaleDateString('en-CA');
            const dayEl = document.createElement('div');
            dayEl.className = `day ${dateStr === selectedDateStr ? 'selected' : ''}`;
            
            if (dateStr === new Date().toLocaleDateString('en-CA')) dayEl.classList.add('today');
            
            dayEl.innerHTML = `<span>${d}</span>`;
            
            const dailyTasks = allTasks[dateStr] || [];
            if (dailyTasks.length > 0) {
                const doneCount = dailyTasks.filter(t => t.done).length;
                const percent = (doneCount / dailyTasks.length) * 100;
                dayEl.innerHTML += `<div class="day-progress-mini"><div class="day-progress-fill" style="width:${percent}%"></div></div>`;
            }

            dayEl.ondragover = (e) => { e.preventDefault(); dayEl.classList.add('drag-over'); };
            dayEl.ondragleave = () => dayEl.classList.remove('drag-over');
            dayEl.ondrop = (e) => {
                e.preventDefault();
                dayEl.classList.remove('drag-over');
                const taskText = e.dataTransfer.getData("text/plain");
                copyTaskToDate(taskText, dateStr);
            };

            dayEl.onclick = () => selectDate(dateStr);
            grid.appendChild(dayEl);
        }
    }

    function selectDate(dateStr) {
        selectedDateStr = dateStr;
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const displayDate = new Date(dateStr + "T00:00:00").toLocaleDateString(undefined, options);
        document.getElementById('selectedDateTitle').innerText = displayDate;
        renderCalendar();
        renderTasks();
    }

    function renderTasks() {
        const list = document.getElementById('taskList');
        const tasks = allTasks[selectedDateStr] || [];
        list.innerHTML = '';
        
        tasks.forEach((task, i) => {
            const li = document.createElement('li');
            li.setAttribute('draggable', 'true');
            li.ondragstart = (e) => e.dataTransfer.setData("text/plain", task.text);
            
            li.innerHTML = `
                <span class="task-text ${task.done ? 'completed' : ''}" onclick="toggleTask(${i})">${task.text}</span>
                <button class="delete-btn" onclick="deleteTask(${i})">‚úï</button>
            `;
            list.appendChild(li);
        });

        const doneCount = tasks.filter(t => t.done).length;
        const progress = tasks.length ? Math.round((doneCount / tasks.length) * 100) : 0;
        
        document.getElementById('mainProgressBar').style.width = progress + '%';
        document.getElementById('percentLabel').innerText = progress + '%';
        
        localStorage.setItem('persistentCalendarTasks', JSON.stringify(allTasks));
    }

    // TASK MANAGEMENT
    function addTask() {
        const text = document.getElementById('taskInput').value.trim();
        if (!text) return;
        if (!allTasks[selectedDateStr]) allTasks[selectedDateStr] = [];
        allTasks[selectedDateStr].push({ text: text, done: false });
        document.getElementById('taskInput').value = '';
        renderTasks();
        renderCalendar();
    }

    function copyTaskToDate(text, targetDateStr) {
        if (!allTasks[targetDateStr]) allTasks[targetDateStr] = [];
        allTasks[targetDateStr].push({ text: text, done: false });
        renderCalendar();
        if (targetDateStr === selectedDateStr) renderTasks();
    }

    window.toggleTask = (i) => {
        allTasks[selectedDateStr][i].done = !allTasks[selectedDateStr][i].done;
        renderTasks();
        renderCalendar();
    };

    window.deleteTask = (i) => {
        allTasks[selectedDateStr].splice(i, 1);
        renderTasks();
        renderCalendar();
    };

    window.changeMonth = (dir) => {
        currentViewDate.setMonth(currentViewDate.getMonth() + dir);
        renderCalendar();
    };

    // GOOGLE CALENDAR INTEGRATION
    function gapiLoaded() { gapi.load('client', intializeGapiClient); }
    
    async function intializeGapiClient() {
        await gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"] });
        gapiInited = true;
    }
    
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', });
        gisInited = true;
    }

    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) throw (resp);
            await listUpcomingEvents();
        };
        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }

    async function listUpcomingEvents() {
        const response = await gapi.client.calendar.events.list({
            'calendarId': 'primary',
            'timeMin': (new Date()).toISOString(),
            'showDeleted': false,
            'singleEvents': true,
            'maxResults': 10,
            'orderBy': 'startTime',
        });
        const events = response.result.items;
        
        events.forEach(event => {
            const date = (event.start.dateTime || event.start.date).split('T')[0];
            if (!allTasks[date]) allTasks[date] = [];
            const exists = allTasks[date].some(t => t.text === event.summary);
            if (!exists) {
                allTasks[date].push({ text: `üìÖ ${event.summary}`, done: false });
            }
        });
        
        localStorage.setItem('persistentCalendarTasks', JSON.stringify(allTasks));
        renderCalendar();
        renderTasks();
        alert("Google Events Synced!");
    }

    // INITIALIZE APP
    selectDate(selectedDateStr);
</script>

</body>
</html>